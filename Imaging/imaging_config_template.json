{
    "name": "Imaging/imaging_config_template.json",

    "camera_config": {
        "core_attr": {
            "exp_time": 10,
            "binning": [1, 1],
            "roi": [0, 2048, 0, 2048],
            "clear_mode": 0
        },
        "splice_plugins_enable": false,
        "splice_plugin_setting": [
            {
                "name": "pluginname1",
                "parameters": [
                    {
                        "name": "module_call_order",
                        "value":  1
                    },
                    {
                        "name": "paramname",
                        "value":  1
                    }
                ]
            },
            {
                "name": "pluginname2",
                "parameters": [
                    {
                        "name": "module_call_order",
                        "value":  1
                    },
                    {
                        "name": "paramname",
                        "value":  1
                    }
                ]
            }
                                 ]
    },

    "serial_port_config": {
        "port_id": "/dev/ttyACM0",
        "baudrate": 9800,
        "timeout": 0.0
    },

    "acquisition_config": {
        "enable_gpu" : 1,
        "vid_writer": {"fourcc": "MJPG", "fps": 25, "nrows": 297, "ncols": 337, "frame_var": "d_frame_warp"},
        "vid_save_path": "/home/pb/PycharmProjects/WideFlow/session_results/vid.avi",
        "meta_save_path": "/home/pb/PycharmProjects/WideFlow/session_results/meta.txt",
        "num_of_frames": 100,
        "capacity": 32,
        "init_process_list": [0, 1]
    },

    "feedback_config": {
        "pattern_path": "/home/pb/PycharmProjects/WideFlow/test_patterns/pattern_smooth_threshold_297_337_32.tif",
        "metric_threshold": 0.3,
        "arduino_script_path": "",
        "inter_feedback_delay": 1e3
    },

    "rois_data": {
        "file_path": "/home/pb/PycharmProjects/WideFlow/data/cortex_map/allen_2d_cortex_rois_extended.h5",
        "cortex_file_path": "/home/pb/PycharmProjects/WideFlow/data/cortex_map/allen_2d_cortex.h5",
        "cortex_matching_point": {
              "match_p_src": null,
              "match_p_dst": null,
              "minimal_n_points": 17
          }
    },

    "allocation_config": {
        "first_stage": [
            {"name": "d_frame_warp_flat", "size": [100089, 1], "dtype": "uint16", "init": null},
            {"name": "buffer_warp", "size": [32, 297, 337], "dtype": "float32", "init": null},
            {"name": "dff_oldest", "size": [297, 337], "dtype": "float32", "init": null},
            {"name": "th_oldest", "size": [297, 337], "dtype": "float32", "init": null},
            {"name": "d_pattern_std", "size": [], "dtype": "float32",
                "init": {
                    "function": "cp.std",
                    "args": ["pattern", "dtype=cp.float32", "out=d_pattern_std"]
                       }
            },
            {"name": "d_pattern_mean", "size": [], "dtype": "float32",
                "init": {
                    "function": "cp.mean",
                    "args": ["pattern", "dtype=cp.float32", "out=d_pattern_mean"]
                }
            },
            {"name": "baseline_conv_kernel", "size": [5, 1, 1], "dtype": "float32",
                "init": {
                    "function": "0.2*cp.ones",
                    "args": ["[5, 1, 1]"]
                }
            },
            {"name": "nrows", "size": [], "dtype": "uint16",
                "init": {
                    "function": "int",
                    "args": ["297"]
                }
            },
            {"name": "ncols", "size": [], "dtype": "uint16",
                "init": {
                    "function": "int",
                    "args": ["337"]
                }
            }
        ],
        "second_stage": [
            {"name": "bs", "size": [297, 337], "dtype": "float32",
                "init": {
                    "function": "baseline_calc_carbox",
                    "args": ["buffer_warp", "baseline_conv_kernel"]
                }
            },
            {"name": "buffer_dff", "size": [32, 297, 337], "dtype": "float32",
                "init": {
                    "function": "dff",
                    "args": ["buffer_warp", "bs"]
                }
            },
            {"name": "d_std_map", "size": [297, 337], "dtype": "float32",
                "init":{
                    "function": "cp.std",
                    "args": ["buffer_dff", "0", "cp.float32"]
                }
            },
            {"name": "buffer_dff_temporal_mean", "size": [297, 337], "dtype": "float32",
                "init": {
                    "function": "cp.mean",
                    "args": ["buffer_dff", "axis=0"]
                       }
            },
            {"name": "buffer_th", "size": [32, 297, 337], "dtype": "float32", "init": null},
            {"name": "d_buffer_th_mean", "size": [1], "dtype": "float32",
                "init": {
                    "function": "cp.mean",
                    "args": ["buffer_th"]
                       }
            },
            {"name": "d_buffer_th_std", "size": [1], "dtype": "float32",
                "init": {
                    "function": "cp.std",
                    "args": ["buffer_th"]
                }
            }
        ]
    },

    "preprocess_pipeline_config": [
        {
            "name": "warp",
            "function": "csn.map_coordinates",
            "args": ["d_frame", "coordinates", "d_frame_warp_flat", "1"],
            "return": {"buffer_type": "None", "to": "None"}
        },
        {
            "name": "reshape",
            "function": "cp.reshape",
            "args": ["d_frame_warp_flat", "(297, 337)"],
            "return": {"buffer_type": "circ_buffer", "to": "buffer_warp"}
        },
        {
            "name": "baseline",
            "function": "baseline_calc_carbox",
            "args": ["cp.roll(buffer_warp, -ptr, 0)", "baseline_conv_kernel"],
            "return": {"buffer_type": "buffer", "to":"bs"}
        },
        {
            "name": "oldest buffer_dff sample ",
            "function": "cp.array",
            "args": ["buffer_dff[ptr, :, :]"],
            "return": {"buffer_type": "buffer", "to":"dff_oldest"}
        },
        {
            "name": "dff",
            "function": "dff",
            "args": ["buffer_warp[ptr, :, :]", "bs"],
            "return": {"buffer_type": "circ_buffer", "to":"buffer_dff"}
        },
        {
            "name": "buffer_dff temporal std",
            "function": "cp.std",
            "args": ["buffer_dff", "0", "cp.float32", "d_std_map"],
            "return": {"buffer_type": "None", "to":"None"}
        },
         {
            "name": "buffer_dff temporal mean update",
            "function": "update_temporal_mean",
            "args": ["buffer_dff_temporal_mean", "dff_oldest", "buffer_dff[ptr, :, :]", "capacity"],
            "return": {"buffer_type": "buffer", "to": "buffer_dff_temporal_mean"}
        },
        {
            "name": "oldest buffer_th sample ",
            "function": "cp.array",
            "args": ["buffer_th[ptr, :, :]"],
            "return": {"buffer_type": "buffer", "to":"th_oldest"}
        },
        {
            "name": "threshold",
            "function": "std_threshold",
            "args": ["buffer_dff", "buffer_th", "d_std_map", "1", "buffer_dff_temporal_mean"],
            "return": {"buffer_type": "None", "to":"None"}
        },
        {
            "name": "buffer_th std update",
            "function": "update_std",
            "args": ["d_buffer_th_std", "th_oldest", "buffer_th[ptr, :, :]", "capacity*nrows*ncols", "d_buffer_th_mean"],
            "return": {"buffer_type": "buffer", "to":"d_buffer_th_std"}
        },
        {
            "name": "buffer_th mean update",
            "function": "update_mean",
            "args": ["d_buffer_th_mean", "th_oldest", "buffer_th[ptr, :, :]", "capacity*nrows*ncols", "None"],
            "return": {"buffer_type": "buffer", "to":"d_buffer_th_mean"}
        },
        {
            "name": "mask",
            "function": "cp.multiply",
            "args": ["buffer_th", "d_mask_stack", "buffer_th"],
            "return": {"buffer_type": "None", "to":"None"}
        }
    ],

    "metric_config": {
        "method": "Temporal Cross-Correlation",
        "function": "cross_corr",
        "args": ["cp.roll(buffer_th, -ptr)", "pattern", "d_buffer_th_mean", "d_buffer_th_std", "d_pattern_mean", "d_pattern_std"]
    },

    "visualization_config": {
        "show_live_stream": {"status": true, "var_name": "buffer_dff", "size": [297, 337], "dtype": "float32"},
        "show_rois_trace": {"status": false, "var_name": "rois_trace", "size": [56, 1], "dtype": "float32"},
        "show_pattern_weight": false
    }
}